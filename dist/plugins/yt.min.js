import HTML from '../html.min.js';
let _yt_api=function(){var t="https://www.youtube.com/s/player/3c3086a1/www-widgetapi.vflset/www-widgetapi.js";try{var i=window.trustedTypes.createPolicy("youtube-widget-api",{createScriptURL:function(t){return t}});t=i.createScriptURL(t)}catch(t){}this._YT||(this._YT={loading:0,loaded:0}),this._YTConfig||(this._YTConfig={host:"https://www.youtube.com"}),this._YT.loading||(this._YT.loading=1,function(){var i=[];this._YT.ready=function(t){this._YT.loaded?t():i.push(t)}.bind(this),window.onYTReady=function(){this._YT.loaded=1;for(var t=0;t<i.length;t++)try{i[t]()}catch(t){}}.bind(this),this._YT.setConfig=function(t){for(var i in t)t.hasOwnProperty(i)&&(this._YTConfig[i]=t[i])}.bind(this);var e=document.createElement("script");e.type="text/javascript",e.id="www-widgetapi-script",e.src=t,e.async=!0;var n=document.currentScript;if(n){var r=n.nonce||n.getAttribute("nonce");r&&e.setAttribute("nonce",r)}var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(e,a)}.bind(this).bind(this)())};
export default class YT extends HTML{constructor(e="_YT_"+Math.random().toString(36).substring(7)){super(),this._ready=!1,this._iframe_id=e,delete this._player,_yt_api.call(this),this._createYT(e)}_createYT(){var e=document.createElement("div");e.id=this._iframe_id,e.style.display="none",e.style.pointerEvents="none",document.body.append(e);let t={height:"144",width:"100%",playerVars:{controls:0,disablekb:1,fs:0,modestbranding:1,playsinline:1}};this._YT.ready(function(){let e=function(e){return function(t){return this[e](t)}.bind(this)}.bind(this);this._player=new window.YT.Player(this._iframe_id,t),this._player.addEventListener("onStateChange",e("_onLoad")),this._player.addEventListener("onStateChange",e("_onTimeUpdate")),this._player.addEventListener("onStateChange",e("_onStateChange")),this._player.addEventListener("onError",e("_onError")),this._player.addEventListener("onReady",e("_onReady"))}.bind(this))}_onLoad(e){if(!this._player.ready)switch(e.data){case 5:this._player.setVolume(0),this._player.playVideo();break;case 1:this._player.pauseVideo();break;case 2:this._player.ready=!0,this._player.setVolume(100),this._publish("loaded")}}_onTimeUpdate(e){1==e.data&&(this._player._myTimer=setInterval(function(){this._publish("timeupdate")}.bind(this),250)),1!=e.data&&clearInterval(this._player._myTimer)}_onStateChange(e){if(this._player.ready)switch(e.data){case-1:break;case 0:this._publish("ended");break;case 3:case 1:this._publish("play");break;case 2:this._publish("pause");break;case 5:this._publish("loaded")}}_onError(e){this._publish("error")}_onReady(e){console.log("Youtube is ready"),this._ready=!0,this._publish("ready")}load(e){if(!this.constructor._validTrack(e))throw new Error("Invalid Filetype");this._player.ready=!1;let t=this.waitForEvent("loaded");try{let r=YT.getYoutubeId(e.src),a=this.getStatus().volume;this._player.cueVideoById(r,0),1!=a&&t.then(function(e){return this.setVolume(a).then(function(){return e})}.bind(this))}catch(e){this._publish("error")}return t}pause(){return 2==this._player.getPlayerState()?Promise.resolve():(this._player.pauseVideo(),this.waitForEvent("pause"))}play(){return 1==this._player.getPlayerState()?Promise.resolve():(this._player.playVideo(),this.waitForEvent("play"))}seek(e){this._player.seekTo(e,!0);let t=this;if(e>=this.getStatus().duration)return this.waitForEvent("ended");let r=this.getStatus().time,a=function(){t._publish("timeupdate")};return e==r?a():(this.wait(function(){return t.getStatus().time},r,a,50),this.waitForEvent("timeupdate"))}fastForward(e){return e+=this._player.getCurrentTime(),this.seek(e)}setVolume(e){e>1&&(e=1),e<0&&(e=0),this._player.setVolume(100*e);let t=this,r=this.getStatus().volume,a=function(){t._publish("volumechange")},i=this.waitForEvent("volumechange");return e==r&&a(),e!=r&&this.wait(function(){return t.getStatus().volume},r,a,5),i}stop(){return this.pause().then(this.chain("seek",0))}getStatus(){return{src:this._player.getVideoUrl(),time:this._player.getCurrentTime(),duration:this._player.getDuration(),volume:this._player.getVolume()/100,paused:1!=this._player.getPlayerState()}}destroy(){return this._player.destroy(),document.getElementById(this._iframe_id).remove(),clearInterval(this._player._myTimer),delete this._iframe_id,super.destroy()}}YT.Track=class extends HTML.Track{constructor(e){super(e),this.filetype="YT"}},YT.Track.fromJSON=function(e){return new YT.Track(JSON.parse(e))},YT.getYoutubeId=function(e){try{let t=new URL(e);if("www.youtube.com"==t.hostname||"youtu.be"==t.hostname){if("/watch"==t.pathname){let e=t.search.indexOf("?v=");return t.search.substr(e+3,11)}return t.pathname.substr(1,11)}throw new Error("Invalid url")}catch(e){throw new Error("Invalid url")}},YT._validURL=function(e){try{let t=new URL(e);return"www.youtube.com"==t.hostname||"youtu.be"==t.hostname}catch(e){return!1}};
